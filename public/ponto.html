<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Ponto</title>
 <link rel="icon" href="favicon.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#0f172a; color:#e2e8f0; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:0.5rem; }
    .stat { font-size:1.5rem; font-weight:700; }
    .btn-success { background:#10b981; border:none; }
    .btn-success:hover { background:#059669; }
    h2, h5 { color:#f1f5f9; }
    @media (max-width: 768px) {
      .row > .col-lg-6 { margin-bottom:1rem; }
      form button { width:100%; }
    }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <!-- Navbar-like -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h2 class="m-0">Dashboard de Ponto</h2>
      <div class="d-flex flex-wrap gap-2">
        <a href="/historico.html" class="btn btn-outline-light btn-sm">Histórico</a>
        <a href="/alterar.html" class="btn btn-warning btn-sm">Alterar Usuário/Senha</a>
        <a id="adminLink" href="/admin.html" class="btn btn-info btn-sm d-none">Admin</a>
        <a href="/logout" class="btn btn-danger btn-sm">Sair</a>
      </div>
    </div>

    <p id="usuario" class="mb-3">Usuário: ...</p>

    <!-- Bater Ponto -->
    <form action="/ponto" method="POST" class="mb-4 text-center">
      <button type="submit" class="btn btn-success btn-lg px-5 py-2">BATER PONTO</button>
    </form>

    <!-- KPIs -->
    <div class="row g-3 mb-4 text-center">
      <div class="col-md-4">
        <div class="card p-3">
          <div>Horas Totais</div>
          <div id="kpiTotal" class="stat">...</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <div>Mês Atual</div>
          <div id="kpiMes" class="stat">...</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <div>Hoje</div>
          <div id="kpiHoje" class="stat">...</div>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Horas por Dia</h5>
            <input id="mesInput" type="month" class="form-control form-control-sm w-auto" />
          </div>
          <canvas id="chartDia" height="150"></canvas>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Horas por Mês</h5>
            <input id="anoInput" type="number" min="2000" class="form-control form-control-sm w-auto" />
          </div>
          <canvas id="chartMes" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const fmtHorasMin = (min) => {
      const h = Math.floor(min/60);
      const m = min%60;
      return `${h}h ${m}m`;
    };

    async function carregaUsuario() {
      const r = await fetch("/api/usuario", { credentials:"same-origin" });
      const u = await r.json();
      document.getElementById("usuario").textContent = `Usuário: ${u.username} (${u.role})`;
      if (u.role === "admin") document.getElementById("adminLink").classList.remove("d-none");
    }

    async function kpis() {
      const total = await (await fetch("/api/total-horas")).json();
      document.getElementById("kpiTotal").textContent = total.total;

      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      const porDia = await (await fetch(`/api/horas-por-dia?yearMonth=${ym}`)).json();
      const minMes = Math.round(porDia.data.reduce((s,h)=>s+h,0)*60);
      document.getElementById("kpiMes").textContent = fmtHorasMin(minMes);

      const dd = String(now.getDate()).padStart(2,"0");
      const mm = String(now.getMonth()+1).padStart(2,"0");
      const labelHoje = `${dd}/${mm}`;
      const idxHoje = porDia.labels.indexOf(labelHoje);
      const minHoje = idxHoje >= 0 ? Math.round(porDia.data[idxHoje]*60) : 0;
      document.getElementById("kpiHoje").textContent = fmtHorasMin(minHoje);
    }

    let chartDia, chartMes;

    async function graficoDia(ym) {
      const resp = await fetch(`/api/horas-por-dia?yearMonth=${ym}`);
      const { labels, data } = await resp.json();
      const ctx = document.getElementById("chartDia").getContext("2d");
      if (chartDia) chartDia.destroy();
      chartDia = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Horas", data, backgroundColor:'#3b82f6' }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    async function graficoMes(ano) {
      const resp = await fetch(`/api/horas-por-mes?year=${ano}`);
      const { labels, data } = await resp.json();
      const ctx = document.getElementById("chartMes").getContext("2d");
      if (chartMes) chartMes.destroy();
      chartMes = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Horas", data, borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.2)', tension:0.3 }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    (function initInputs() {
      const now = new Date();
      document.getElementById("mesInput").value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      document.getElementById("anoInput").value = now.getFullYear();
    })();

    document.getElementById("mesInput").addEventListener("change", e => graficoDia(e.target.value));
    document.getElementById("anoInput").addEventListener("change", e => graficoMes(e.target.value));

    (async function start() {
      await carregaUsuario();
      await kpis();
      await graficoDia(document.getElementById("mesInput").value);
      await graficoMes(document.getElementById("anoInput").value);
    })();
  </script>
</body>
</html>
